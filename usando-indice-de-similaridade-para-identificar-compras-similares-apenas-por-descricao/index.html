<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Usando índice de similaridade para identificar compras similares apenas por descrição - Ana Paula Appel</title><meta name="description" content="Vivemos em um mundo onde a explosão de dados é um fato real. Sendo assim a “busca” é uma ferramenta cada dia mais&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://anapaulaappel.github.io/usando-indice-de-similaridade-para-identificar-compras-similares-apenas-por-descricao/"><link rel="alternate" type="application/atom+xml" href="https://anapaulaappel.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://anapaulaappel.github.io/feed.json"><meta property="og:title" content="Usando índice de similaridade para identificar compras similares apenas por descrição"><meta property="og:image" content="https://anapaulaappel.github.io/media/website/Ana.jpg"><meta property="og:site_name" content="Ana Paula Appel"><meta property="og:description" content="Vivemos em um mundo onde a explosão de dados é um fato real. Sendo assim a “busca” é uma ferramenta cada dia mais&hellip;"><meta property="og:url" content="https://anapaulaappel.github.io/usando-indice-de-similaridade-para-identificar-compras-similares-apenas-por-descricao/"><meta property="og:type" content="article"><style>:root{--primary-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--secondary-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://anapaulaappel.github.io/assets/css/fontawesome-all.min.css?v=dbf9d822cefe851ba6f66e1ad57e8987"><link rel="stylesheet" href="https://anapaulaappel.github.io/assets/css/academicons.min.css?v=3b48c71c70d59c14cdd6334ee1fef08f"><link rel="stylesheet" href="https://anapaulaappel.github.io/assets/css/style.css?v=681b5cd1e3adaff7740ef64e287f10a7"><noscript><link rel="stylesheet" href="https://anapaulaappel.github.io/assets/css/noscript.css?v=e9cb14177f0b4682295baa0a917ba60a"></noscript><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://anapaulaappel.github.io/usando-indice-de-similaridade-para-identificar-compras-similares-apenas-por-descricao/"},"headline":"Usando índice de similaridade para identificar compras similares apenas por descrição","datePublished":"2022-07-29T14:50","dateModified":"2022-08-02T14:48","description":"Vivemos em um mundo onde a explosão de dados é um fato real. Sendo assim a “busca” é uma ferramenta cada dia mais&hellip;","author":{"@type":"Person","name":"Ana Paula Appel","url":"https://anapaulaappel.github.io/authors/ana-paula-appel/"},"publisher":{"@type":"Organization","name":"Ana Paula Appel"}}</script><style>#wrapper > .bg {
               background-image: url(https://anapaulaappel.github.io/assets/images/overlay.png), linear-gradient(0deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)), url(https://anapaulaappel.github.io/media/website/Ana-3.jpg);
           }</style></head><body class="is-preload"><div id="wrapper"><header id="header"><a class="logo" href="https://anapaulaappel.github.io/">Ana Paula Appel</a></header><nav id="nav"><ul class="links"><li><a href="https://anapaulaappel.github.io/" target="_self">Home</a></li><li class="has-submenu"><a href="https://anapaulaappel.github.io/tags/projects/" target="_self" aria-haspopup="true">Projects</a><ul class="nav__submenu level-2" aria-hidden="true"><li><a href="https://anapaulaappel.github.io/temporally-evolving-community-detection-and-prediction-in-heterogeneous-networks/" target="_self">TG</a></li><li><a href="https://anapaulaappel.github.io/predicting-account-receivables-with-machine-learning/" target="_self">MLF</a></li><li><a href="https://anapaulaappel.github.io/projects/" target="_self">HIG</a></li></ul></li><li class="has-submenu"><a href="https://anapaulaappel.github.io/tags/media/" target="_self" aria-haspopup="true">Media</a><ul class="nav__submenu level-2" aria-hidden="true"><li><a href="https://anapaulaappel.github.io/talks/" target="_self">Talks</a></li><li><a href="https://anapaulaappel.github.io/award/" target="_self">Awards</a></li><li><a href="https://anapaulaappel.github.io/interviews/" target="_self">Interviews</a></li></ul></li><li><a href="https://anapaulaappel.github.io/patents/" target="_self">Patents</a></li></ul><ul class="icons"><li><a href="https://scholar.google.com.br/citations?user&#x3D;O-jfiZMAAAAJ&amp;hl&#x3D;pt-BR" class="icon brands fa-google"><span class="label">Scholar</span></a></li><li><a href="https://www.spreaker.com/show/crazy-for-data" class="icon solid fa-podcast"><span class="label">Podcast</span></a></li><li><a href="https://dblp.org/pid/00/4729.html" class="icon solid fa-book"><span class="label">DBLP</span></a></li><li><a href="mailto:paulinha.appel@gmail.com" class="icon Social fa-envelope"><span class="label">Mail</span></a></li><li><a href="https://www.instagram.com/crazyfordata/?hl&#x3D;en" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li><li><a href="https://www.linkedin.com/in/paulinhaappel/" class="icon brands fa-linkedin"><span class="label">LinkedIn</span></a></li></ul></nav><main id="main"><article class="post"><header class="major"><h1>Usando índice de similaridade para identificar compras similares apenas por descrição</h1><p class="post__inner"></p></header><div class="post__inner post__entry"><p class="graf graf--p">Vivemos em um mundo onde a explosão de dados é um fato real. Sendo assim a “busca” é uma ferramenta cada dia mais importante. Estamos sempre buscando um produto, uma informação, um texto, etc.</p><p>B<span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">usca é algo que já advém desde o surgimento dos bancos de dados relacionais na década de 70. E não é atoa que no mundo de dados saber SQL esta cada vez mais relevante. Contudo, quando a busca é em dados estruturados a vida, principalmente do cientista de dados, fica mais fácil. Mas quando o que queremos buscar é um texto mais longo, uma imagem, uma música ou qualquer coisa que seja diferente de um código/número ou um texto curto como um nome a situação muda muito.</span></p><p class="graf graf--p">A área de recuperação da informação também não é nova, com o advento da internet a mais de 30 anos atrás essa área teve um destaque grande e a busca de informação não estruturada se tornou possível. Entretanto o volume de documentos buscados e contidos na base para ser pesquisado passou de milhares para milhões o que fez com que uma simples indexação dos documentos não fosse a melhor opção.</p><p class="graf graf--p">O foco desse artigo é a busca por texto, não documentos grandes, mas sim sentenças. As técnicas clássicas de recuperação de informação proveram uma fundação sólida para muitos serviços e aplicações, mas elas não permitem alguns tipos de consultas que são necessárias.</p><p class="graf graf--p">A principal diferença entre a recuperação de informação clássica e a baseada em semântica é o uso de pequenos vetores para representar a informação. O uso de <em class="markup--em markup--p-em">embeddings</em> é poderoso e pode ser usado por praticamente todo tipo de dados e até a combinação deles.</p><p class="graf graf--p">No caso do projeto feito aqui, o texto era a descrição de produtos ou serviços comprados por uma empresa, por exemplo ‘chave de fenda 1/8x4”’ou ‘<em class="markup--em markup--p-em">pão de queijo</em>’. Esses produtos não têm um código no catálogo e dependem de uma descrição curta dada pelo comprador. Como em qualquer empresa é necessário auditar as compras para evitar desvio e desperdício de dinheiro, sendo assim como encontrar compras similares passadas usando apenas a descrição?</p><p class="graf graf--p">O primeiro passo foi entender a descrição dos produtos. Como podemos ver na Figura 1 os textos são pequenos, na média 5 palavras. Por isso, não da para fazer limpeza nos dados e a remoção dos chamados stop words (artigos, pronome, etc)</p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*2mUbzbXHt37bPTWUA-z3Sw.png" data-is-external-image="true" data-image-id="1*2mUbzbXHt37bPTWUA-z3Sw.png" data-width="484" data-height="286"></figure><figcaption class="imageCaption">Figura 1 — Distribuição do tamanho da descrição do texto</figcaption></figure><p class="graf graf--p">Nesse caso usamos um <em class="markup--em markup--p-em">sentence embedding</em> direto e o escolhido foi o USE (<em class="markup--em markup--p-em">Universal Sentence Encoding — </em><a href="https://www.tensorflow.org/hub/tutorials/semantic_similarity_with_tf_hub_universal_encoder" data-href="https://www.tensorflow.org/hub/tutorials/semantic_similarity_with_tf_hub_universal_encoder" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.tensorflow.org/hub/tutorials/semantic_similarity_with_tf_hub_universal_encoder</a>) que funciona muito bem para textos curtos, é mais leve e tem versão multilingual. Poderíamos usar outros como word2vec, ou BERT (<a href="https://www.tensorflow.org/text/tutorials/classify_text_with_bert" data-href="https://www.tensorflow.org/text/tutorials/classify_text_with_bert" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.tensorflow.org/text/tutorials/classify_text_with_bert</a>) ou ainda aplicar o TF-IDF.</p><p>No caso do projeto em questão a nossa abordagem foi gerar um <em class="markup--em markup--p-em">embedding</em> para todas as descrições independentes se o item tinha um código ou não pois na comparação de compras com texto parecido queremos como resposta compra similares em relação ao texto.</p><p class="graf graf--p">A geração de <em>embedding</em> nada mais é do que um modelo de Machine Learning pré-treinado na qual é utilizado para transformar um texto em um vetor numérico, nesse caso um vetor de 512 posições de float. </p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*TM-ZdLpO8umpqQ7myn4Lcw.png" data-is-external-image="true" data-image-id="1*TM-ZdLpO8umpqQ7myn4Lcw.png" data-width="324" data-height="424"></figure><figcaption class="imageCaption">Figura 2 — geração de embedding</figcaption></figure><p class="graf graf--p">Com os <em>embeddings</em> gerados agora precisamos usa-los para identificar os produtos similares. Quando trabalhamos com similaridade não temos relação de ordem. Não falamos que o <em>embedding</em> é menor ou maior que outro embedding, falamos o quão similar eles são. Nesse caso é medida a distância entre dois vetores que estamos querendo comparar. </p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*ynN3yYdpMizeSCxXESC1jg.png" data-is-external-image="true" data-image-id="1*ynN3yYdpMizeSCxXESC1jg.png" data-width="492" data-height="308"></figure><figcaption class="imageCaption">Figura 3 — Comparação entre dois vetores que representam texto que queremos comparar. </figcaption></figure><p class="graf graf--p">Nesse caso temos dois tipos de consultas disponíveis, K-NN (K nearest neighbor) e Range search (consulta por distância). No caso do K-NN damos o número de vizinhos que queremos recuperar (K) e a consulta retornará esses vizinhos mais próximos em relação distância entre os dois vetores que representam o texto que esta sendo comparado. Nessa consulta não da para saber o quão similar é o resultado, já que os vizinhos próximos podem ser bem próximo ou não tão próximos como mostramos na Figura 4. O vetor azul (que representa um objeto de consulta, um texto) possuí 3 vizinhos que são bem próximos e consequentemente similares, já o vetor verde os 3 vizinhos não são tão próximos assim e portanto nem tanto similares.</p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*I9lcBLiMjrSt3AgE8xgTAw.png" data-is-external-image="true" data-image-id="1*I9lcBLiMjrSt3AgE8xgTAw.png" data-width="578" data-height="362"></figure><figcaption class="imageCaption">Figura 4 — exemplo de k=3 vizinhos mais próximo. O ponto azul tem mais vizinhos próximos que o verde. </figcaption></figure><p class="graf graf--p">Na Figura 5 mostramos um exemplo mais concreto com o resultado da consulta da Figura 4. Suponha que o ponto azul seja o texto "Saco de lixo 60 preto" e o ponto verde "Revestimento de azulejo". Dependendo do que tiver indexado podemos ter o resultado de exemplo da Figura 5. Na qual os 3 vizinhos do texto azul são texto muito similares e do texto verde são muito distintos. Mas como pedimos 3 vizinhos a consulta retornará 3 independentemente de quão similar sejam. </p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*_Srzue8swdQVHcrEiotNEw.png" data-is-external-image="true" data-image-id="1*_Srzue8swdQVHcrEiotNEw.png" data-width="1692" data-height="512"></figure><figcaption class="imageCaption">Figura 5 — Exemplo do resultado de consulta da Figura 4.</figcaption></figure><p class="graf graf--p">Esse tipo de consulta não tem como tratar lista de empate, supondo, por exemplo, que tivéssemos mais resultados similares para "Saco de lixo 60 preto" só os 3 mais similares são retornados. </p><p class="graf graf--p">Já na consulta por distância, passamos como valor o que chamamos de raio de consulta que é o valor máximo de distância entre o texto de consulta e o texto similar. Essa distância é calculada usando a distância Euclidiana ou a Cosseno na maioria dos casos. Mas, a menos que tenhamos um limite máximo fica difícil definir um raio igual para todos os pontos, já que no caso do ponto azul se o raio for grande muitos pontos serão retornados enquanto no verde se for pequeno pode não retornar ninguém como mostrado na Figura 6. </p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*-Xy_wzw9N_c3vuuiuYhHlg.png" data-is-external-image="true" data-image-id="1*-Xy_wzw9N_c3vuuiuYhHlg.png" data-width="614" data-height="367"></figure><figcaption class="imageCaption">Figura 6 — Busca por distância — range query</figcaption></figure><p class="graf graf--p">Na nossa solução precisávamos de uma maneira de armazenar os embeddings e que pudéssemos realizar consultas K-NN e Range Query, também o ideal é que não fosse necessário reconstruir a estrutura sempre que novos produtos fossem adicionados. Para isso usamos um índice de similaridade chamado FAISS (<a href="https://github.com/facebookresearch/faiss" data-href="https://github.com/facebookresearch/faiss" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://github.com/facebookresearch/faiss</a>). Existem diversas implementações mas essa biblioteca tem uma interface limpa e possui diversos métodos de indexação que podem ser utilizados de acordo com o tamanho do problema que se quer resolver.</p><p class="graf graf--p">No nosso caso caso usamos o IndexFlatL2 e o IndexIDMap que permite a criação do índice com os ID's já que posteriormente precisamos recuperar as outras informações. </p><p class="graf graf--p">Com o índice criado agora vamos para a parte de como usá-lo. No caso da nossa solução a estratégia adotada foi a seguinte: dado um objeto de consulta primeiro recuperamos o vizinho mais próximo, isto é K=1 em uma consulta K-NN. Baseada em uma analise prévia feita com usuários, se a distância for menor de 0,4 realizamos uma range query somando um valor como 0,00001 a distância do vizinho retornado. Esse passo a passo é mostrado na Figura 7.</p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*mGSqdkPh4QDnQ6IknqnMQQ.png" data-is-external-image="true" data-image-id="1*mGSqdkPh4QDnQ6IknqnMQQ.png" data-width="936" data-height="206"></figure><figcaption class="imageCaption">Figura 7 — Realização da consulta K-NN e depois da Range Query</figcaption></figure><p class="graf graf--p">Depois que os produtos similares são encontrados é possível fazer diversas analises como preço, histórico de compra, etc. Essa solução apesar de simples mostrou que é possível aumentar a base de comparação em mais de 50% além de ser escalável. </p><p class="graf graf--p">Na Figura 8 apresentamos a versão simplificada da nossa pipeline de criação do índice e da consulta. </p><figure class="graf graf--figure"><figure class="graf-image"><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/1*6vCbNc2YiibHC1AMA83ywA.png" data-is-external-image="true" data-image-id="1*6vCbNc2YiibHC1AMA83ywA.png" data-width="1893" data-height="615"></figure><figcaption class="imageCaption">Figura 8 — Pipeline de criação do índice e consulta dos produtos similares. </figcaption></figure><p class="graf graf--p">Se você se interessou e curtiu a nossa solução deixe seu comentário. </p><p class="graf graf--p">Espero que tenham gostado!! </p><p class="graf graf--p graf--empty"> </p><p class="graf graf--p graf--empty"> </p><p class="graf graf--p graf--empty"> </p></div><footer class="post__inner post__footer"><p class="post__last-updated">This article was updated on August 2, 2022</p><div class="post__share-tag-container"><div class="post__share"><button class="post__share-button js-post__share-button icon" aria-label="Share button"><i class="fas fa-share-alt"></i></button><div class="post__share-popup js-post__share-popup"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fanapaulaappel.github.io%2Fusando-indice-de-similaridade-para-identificar-compras-similares-apenas-por-descricao%2F" class="js-share icon brands fa-facebook-f" rel="nofollow noopener noreferrer"><span class="label">Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fanapaulaappel.github.io%2Fusando-indice-de-similaridade-para-identificar-compras-similares-apenas-por-descricao%2F&amp;via=%40paulinhaappel&amp;text=Usando%20%C3%ADndice%20de%20similaridade%20para%20identificar%20compras%20similares%20apenas%20por%20descri%C3%A7%C3%A3o" class="js-share icon brands fa-twitter" rel="nofollow noopener noreferrer"><span class="label">Twitter</span> </a><a href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fanapaulaappel.github.io%2Fusando-indice-de-similaridade-para-identificar-compras-similares-apenas-por-descricao%2F&amp;title=Usando%20%C3%ADndice%20de%20similaridade%20para%20identificar%20compras%20similares%20apenas%20por%20descri%C3%A7%C3%A3o" class="js-share icon brands fa-linkedin" rel="nofollow noopener noreferrer"><span class="label">LinkedIn</span></a></div></div></div></footer></article></main><footer id="copyright"><p>Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener">Publii</a></p></footer></div><script src="https://anapaulaappel.github.io/assets/js/jquery.min.js?v=220afd743d9e9643852e31a135a9f3ae"></script><script src="https://anapaulaappel.github.io/assets/js/jquery.scrollex.min.js?v=f89065e3d988006af9791b44561d7c90"></script><script src="https://anapaulaappel.github.io/assets/js/jquery.scrolly.min.js?v=1ed5a78bde1476875a40f6b9ff44fc14"></script><script src="https://anapaulaappel.github.io/assets/js/browser.min.js?v=c07298dd19048a8a69ad97e754dfe8d0"></script><script src="https://anapaulaappel.github.io/assets/js/breakpoints.min.js?v=81a479eb099e3b187613943b085923b8"></script><script src="https://anapaulaappel.github.io/assets/js/util.min.js?v=4201a626f8c9b614a663b3a1d7d82615"></script><script src="https://anapaulaappel.github.io/assets/js/main.min.js?v=149e72e3ae18744a477b480b19e0c6da"></script><script>/*<![CDATA[*/var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};/*]]>*/</script></body></html>